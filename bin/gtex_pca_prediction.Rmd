---
title: "Sample origin prediction using GTEx dataset"
author: "Jose Alquicira Hernandez"
date: "13/09/2017"
output: html_document
---

```{r load_libraries}
library("scPrediction")
library("tidyverse")
```

```{r command_line_args}
argv <- commandArgs(TRUE)
positive.class <- as.character(argv[1])
negative.class <- as.character(argv[2])
# positive.class <- "skin_sun_exposed_lower_leg"
# negative.class <- "skin_not_sun_exposed_suprapubic"
```


# Read and process input data

```{r read_pca_data}
red <- readRDS(paste0("../results/2017-09-21_gtex_pca/pca_", positive.class, "_vs_", negative.class, ".RDS"))
eigenvectors <- red$x
groups <- red$sample
```

# Get significant eigenvectors

```{r}
red.features <- getSignificantEigen(dim.red = red, groups = groups)
```

```{r}
performance <- predictEigen(eigenvectors = eigenvectors,
                            groups = groups,
                            positive.class = positive.class,
                            significant.eigenvectors = red.features, 
                            n.rep = 10,
                            n.cores = 10)
```



```{r save_results}
cat("Saving prediction results...\n")

# Save performance
# performance <- readRDS(paste0("../results/2017-09-14_gtex_pca_prediction/performance_cluster", positive.class, "-", negative.class, ".RDS"))
saveRDS(performance, file = paste0("../results/2017-09-14_gtex_pca_prediction/performance_cluster", positive.class, "-", negative.class, ".RDS"))

# Save table of significant eigenvectors
write.table(red.features$significant.eigenvectors, 
            file = paste0("../results/2017-09-14_gtex_pca_prediction/pvals_significant-cluster_",
                          positive.class,
                          "-",
                          negative.class,
                          ".txt"),
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)

# Save talbe of top N eigenvectors
write.table(red.features$top.n.eigenvectors,
            file = paste0("../results/2017-09-14_gtex_pca_prediction/pvals_all-cluster_",
                          positive.class, "-",
                          negative.class,".txt"),
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)

cat("Results saved...\n")
```

```{r}
p <- plotMetrics(performance, eigen.info =  red.features)
```



```{r save_metrics_plot}
ggsave(filename = paste0("../results/2017-09-14_gtex_pca_prediction/metrics_cluster_", positive.class, "-", negative.class,".png"),
       plot = p,
       width = 20,
       height = 4.5,
       device = "png",
       dpi = 350)
```


```{r display_session_info}
options(width = 120)
devtools::session_info()
```


