---
title: "PCA of GTEx data"
author: "Jose Alquicira Hernandez"
date: "08/09/2017"
output: html_document
---

```{r import_libraries}
library("tidyverse")
library("knitr")
```

```{r command_line_args}
argv <- commandArgs(TRUE)
positive.class <- argv[1]
negative.class <- argv[2]
# positive.class <- "heart_left_ventricle"
# negative.class <- "heart_atrial_appendage"
```


```{r read_gtex_data}
gtex <- readRDS("../data/2017-09-13_gtex_data/gtex_clean.RDS")
```


```{r subset_data}
samples.idx <- (gtex$metadata$subtissue == positive.class) | (gtex$metadata$subtissue == negative.class)
metadata <- gtex$metadata[samples.idx, ]
tpm <- gtex$tpm[,samples.idx]
```


```{r get_sample_summary}
metadata %>% 
  group_by(SMTSD) %>% 
  count() %>% 
  arrange(-n) %>% 
  kable()
```



```{r perform_pca}
pca <- prcomp(log2(t(tpm) + 1), center = TRUE, scale. = TRUE)
```


```{r extract_rotation}
eigenvectors <- as.data.frame(pca$x)

pc.var <- round((pca$sdev**2 / sum(pca$sdev**2))*100, 2)
names(pc.var) <- names(eigenvectors)

eigenvectors$sample <- metadata$subtissue -> pca$sample
```

```{r save_pca}
cat("Saving results...\n")
saveRDS(pca, file = paste0("../results/2017-09-21_gtex_pca/pca_", positive.class, "_vs_", negative.class, ".RDS"))
cat("Results saved...\n")
```



```{r plot_pca}
p12 <- ggplot(eigenvectors, aes(x = PC1, y = PC2, color = sample)) +
  geom_point() +
  scale_color_brewer(palette = "Set1") +
  ggtitle(paste(positive.class, "vs.", negative.class), subtitle = "All genes") + 
  xlab(paste0("PC1 (", pc.var[1], "% variance explained)")) +
  ylab(paste0("PC2 (", pc.var[2], "% variance explained)"))
p13 <- ggplot(eigenvectors, aes(x = PC1, y = PC3, color = sample)) +
  geom_point() +
  scale_color_brewer(palette = "Set1") +
  ggtitle(paste(positive.class, "vs.", negative.class), subtitle = "All genes") + 
  xlab(paste0("PC1 (", pc.var[1], "% variance explained)")) +
  ylab(paste0("PC3 (", pc.var[3], "% variance explained)"))
p23 <- ggplot(eigenvectors, aes(x = PC2, y = PC3, color = sample)) +
  geom_point() +
  scale_color_brewer(palette = "Set1") +
  ggtitle(paste(positive.class, "vs.", negative.class), subtitle = "All genes") + 
  xlab(paste0("PC2 (", pc.var[2], "% variance explained)")) +
  ylab(paste0("PC3 (", pc.var[3], "% variance explained)"))
```


```{r print_pcs}
p12
p13
p23
```



```{r read_de_genes}
de.genes <- read.csv(paste0("../results/2017-09-21_gtex_de_genes/", positive.class, "_vs_", negative.class, ".csv"))
```


```{r remove_de_genes}
tpm.no.deg <- tpm[!(rownames(tpm) %in% de.genes$genes),]
```


```{r perform_pca_no_deg}
pca.no.deg <- prcomp(log2(t(tpm.no.deg) + 1), center = TRUE, scale. = TRUE)
```


```{r extract_rotation_no-deg}
eigenvectors.no.deg <- as.data.frame(pca.no.deg$x)

pc.var.no.deg <- round((pca.no.deg$sdev**2 / sum(pca.no.deg$sdev**2))*100, 2)
names(pc.var.no.deg) <- names(eigenvectors.no.deg)

eigenvectors.no.deg$sample <- metadata$subtissue -> pca.no.deg$sample
```

```{r save_pca_no-deg}
cat("Saving results...\n")
saveRDS(pca.no.deg, file = paste0("../results/2017-09-21_gtex_pca/pca_nodeg_", positive.class, "_vs_", negative.class, ".RDS"))
cat("Results saved...\n")
```


```{r plot_pca_no-deg}
p12 <- ggplot(eigenvectors.no.deg, aes(x = PC1, y = PC2, color = sample)) +
  geom_point() +
  scale_color_brewer(palette = "Set1") +
  ggtitle(paste(positive.class, "vs.", negative.class), subtitle = "All genes") + 
  xlab(paste0("PC1 (", pc.var.no.deg[1], "% variance explained)")) +
  ylab(paste0("PC2 (", pc.var.no.deg[2], "% variance explained)"))
p13 <- ggplot(eigenvectors.no.deg, aes(x = PC1, y = PC3, color = sample)) +
  geom_point() +
  scale_color_brewer(palette = "Set1") +
  ggtitle(paste(positive.class, "vs.", negative.class), subtitle = "All genes") +
  xlab(paste0("PC1 (", pc.var.no.deg[1], "% variance explained)")) +
  ylab(paste0("PC3 (", pc.var.no.deg[3], "% variance explained)"))
p23 <- ggplot(eigenvectors.no.deg, aes(x = PC2, y = PC3, color = sample)) +
  geom_point() +
  scale_color_brewer(palette = "Set1") +
  ggtitle(paste(positive.class, "vs.", negative.class), subtitle = "All genes") + 
  xlab(paste0("PC2 (", pc.var.no.deg[2], "% variance explained)")) +
  ylab(paste0("PC3 (", pc.var.no.deg[3], "% variance explained)"))
```

```{r print_pcs_nodeg}
p12
p13
p23
```

```{r display_session_info}
options(width = 120)
devtools::session_info()
```

