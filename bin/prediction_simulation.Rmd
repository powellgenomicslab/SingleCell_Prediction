---
title: "Splatter"
author: "Jose Alquicira Hernandez"
date: "27/06/2017"
output: html_document
---

# Load libraries

```{r load_libraries}
suppressMessages(library(scPrediction))
suppressMessages(library(splatter))

suppressMessages(library('foreach'))
suppressMessages(library('doParallel'))
```


# Simulate datasets


```{r simulate_data}
sim <- splatSimulate(nGenes = 100, groupCells = c(50, 50), method = "groups", seed = 99, verbose = FALSE)
```

```{r extract_data}
sim.pheno <- phenoData(object = sim)@data
sim.data <- exprs(sim)
```

```{r setup_cluster}
n.cores <- 2
cl <- makeCluster(n.cores, outfile = '')
registerDoParallel(cl)
```


```{r define_iterations}
n <- 2
iter <- seq_len(n)
```

```{r define_output_function}
comb <- function(x, ...) {
  lapply(seq_along(x),
    function(i) c(x[[i]], lapply(list(...), function(y) y[[i]])))
}
```

```{r create_seeds}
# seeds <- sample(1:50000, size = 100, replace = TRUE)
seeds.select <- c(18963,11835,38268,4071,515,38489,43612,37577,24484,20562,28354,30815,29137,29246,23762,15286,33605,26739,22919,32596,14373,46398,46064,39920,24110,20294,41148,48654,34029,25359,3016,22720,43078,45935,7979,430,3033,27125,10152,38860,13293,4566,31483,12965,21939,31440,31397,2100,19793,15853,43780,40804,9741,44354,13126,40070,40929,21237,38687,8988,19795,44104,39181,49170,48984,39446,22446,37099,11091,47020,45130,16437,42807,42560,44595,33712,34490,38548,30927,47522,41510,4189,5421,36331,39808,16249,40572,41146,41607,11705,12381,4728,31350,25172,4763,4181,17638,46408,39838,16460)

seeds.compare <- c(9351,26634,16496,4146,30796,47316,37798,2283,37324,12043,20234,28458,13545,5507,39962,2151,24861,36024,1727,4813,44701,32887,32101,38658,28058,4139,36523,24541,7204,46413,21999,9407,10986,13552,35608,1484,40106,18300,44515,32833,48557,19541,22954,32915,33148,9983,5081,28216,49692,20618,21360,30864,16166,35157,10310,25301,36652,44388,30874,10472,24462,36189,45468,19067,35199,29697,18077,7920,27799,37463,29394,6106,22739,10333,2933,30697,764,34893,27751,12255,28325,42947,31440,39348,48143,27205,341,31589,45188,111,759,5723,36586,36847,33712,47969,3351,23386,35620,40907)
```

```{r}
cat("Bootstrapping starts...\n")
```


```{r}
features <- seq_len(nrow(sim.data))
cell.class <- sim.pheno[,c('Cell', 'Group')]
```



```{r run_predictions}
i <- 1
results <- foreach(i = iter, .combine = comb, .multicombine = TRUE, .init = list(list(), list(), list(), list(), list(), list(), list(), list(), list(), list(), list()), .packages = c("scPrediction")) %dopar% {
  
  cat('Bootstrap replicate:', i, "running....", "\n")
  
  # Random sampling for training and testing datasets ----------------------
  data.train.test <- BuildTrainTest(groups = sim.pheno$Group,
                                    group.select = "Group1",
                                    features = features, 
                                    expression.data = sim.data, 
                                    seed.select = seeds.select[i], 
                                    seed.compare = seeds.compare[i])
  
  # Initialize variables
  test <- data.train.test$test
  training <- data.train.test$training
  response <- data.train.test$response
  
  # Run lasso
  prediction <- FitRegModel(test, training, response,
                                family = "binomial",
                                alpha = 1, 
                                seed = 92)

  lasso <- GetAccuracy(prediction = prediction, cell.class = cell.class)
  

  # Run elastic-net (alpha = 0.9)
  prediction <- FitRegModel(test, training, response,
                                family = "binomial",
                                alpha = 0.9,
                                seed = 92)


  elastic.net.0.9 <- GetAccuracy(prediction = prediction, cell.class = cell.class)

  # Run elastic-net (alpha = 0.5)
  prediction <- FitRegModel(test, training, response,
                                family = "binomial",
                                alpha = 0.5,
                                seed = 92)


  elastic.net.0.5 <- GetAccuracy(prediction = prediction, cell.class = cell.class)

  # Run elastic-net (alpha = 0.1)
  prediction <- FitRegModel(test, training, response,
                                family = "binomial",
                                alpha = 0.1,
                                seed = 92)

  elastic.net.0.1 <- GetAccuracy(prediction = prediction, cell.class = cell.class)

  # Run ridge
  prediction <- FitRegModel(test, training, response,
                                family = "binomial",
                                alpha = 0,
                                seed = 92)

  ridge <- GetAccuracy(prediction = prediction, cell.class = cell.class)

  # Run MARS (Multivariate adaptive regression splines)
  prediction <- RunCaret(test,
                             training,
                             response,
                             method = 'earth',
                             seed = 92)

  mars <-  GetAccuracy(prediction = prediction, cell.class = cell.class)
  

  # Run Random Forests
  prediction <- RunCaret(test,
                             training,
                             response,
                             method = 'rf',
                             seed = 92)
  
  random.forest <- GetAccuracy(prediction = prediction, cell.class = cell.class)
  
  # Run Naive Bayes
  suppressWarnings(prediction <- RunCaret(test,
                             training,
                             response,
                             method = 'nb',
                             seed = 92))
  
  naive.bayes <- GetAccuracy(prediction = prediction, cell.class = cell.class)
  
  # Run SVM with linear kernel
  prediction <- RunCaret(test,
                             training,
                             response,
                             method = 'svmLinear',
                             seed = 92)
  
  svm.linear <- GetAccuracy(prediction = prediction, cell.class = cell.class)
  
  
  # Run Generalized Linear Model
  prediction <- RunCaret(test,
                             training,
                             response,
                             method = 'glm',
                             seed = 92)
  
  glm <- GetAccuracy(prediction = prediction, cell.class = cell.class)
  
  # Neural network
  prediction <- RunCaret(test,
                             training,
                             response,
                             method = 'nnet',
                             seed = 92)
  
  neural.network <- GetAccuracy(prediction = prediction, cell.class = cell.class)


  i <- i  + 1
  return(list(lasso, elastic.net.0.9, elastic.net.0.5, elastic.net.0.1, ridge, mars, random.forest, naive.bayes, svm.linear, glm, neural.network))
}
```

```{r sets_listnames}
names(results) <- c('lasso', 'elastic.net.0.9', 'elastic.net.0.5', 'elastic.net.0.1', 'ridge', 'mars', 'random.forests', 'naive.bayes', 'svm.linear', 'glm', 'neural.network')
```


```{r stop_cluster}
stopCluster(cl)
```

```{r save_results}
saveRDS(results, file = paste0('simulation_', length(unique(sim.pheno$Group)),'-groups_', n, '-' ,'replicates.RDS'))
```
